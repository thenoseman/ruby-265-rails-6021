<!DOCTYPE html>
<html lang="en">
<head>
    <title>CHANGELOG.md</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>
    <div class="banner">
        
        <h1>
            CHANGELOG.md
        </h1>
        <ul class="files">
            
            <li>
                activerecord/CHANGELOG.md
                
                    <a href="https://github.com/rails/rails/blob/f33d52c95217212cbacc8d5e44b5a8e3cdc6f5b3/activerecord/CHANGELOG.md" target="_blank" class="github_url">on GitHub</a>
                
            </li>
            <li>Last modified: 2019-12-31 20:53:00 +0100</li>
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h2 id="label-Rails+6.0.2.1+-28December+18-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.2.1 (December 18, 2019)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+6.0.2+-28December+13-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.2 (December 13, 2019)</h2>
<ul><li>
<p>Share the same connection pool for primary and replica databases in the transactional tests for the same database.</p>

<p><em>Edouard Chin</em></p>
</li><li>
<p>Fix the preloader when one record is fetched using <code>after_initialize</code> but not the entire collection.</p>

<p><em>Bradley Price</em></p>
</li><li>
<p>Fix collection callbacks not terminating when <code>:abort</code> is thrown.</p>

<p><em>Edouard Chin</em>, <em>Ryuta Kamizono</em></p>
</li><li>
<p>Correctly deprecate <code>where.not</code> working as NOR for relations.</p>

<p>12a9664 deprecated where.not working as NOR, however doing a relation query like <code>where.not(relation: { ... })</code> wouldn&#39;t be properly deprecated and <code>where.not</code> would work as NAND instead.</p>

<p><em>Edouard Chin</em></p>
</li><li>
<p>Fix <code>db:migrate</code> task with multiple databases to restore the connection to the previous database.</p>

<p>The migrate task iterates and establish a connection over each db resulting in the last one to be used by subsequent rake tasks. We should reestablish a connection to the connection that was established before the migrate tasks was run</p>

<p><em>Edouard Chin</em></p>
</li><li>
<p>Fix multi-threaded issue for <code>AcceptanceValidator</code>.</p>

<p><em>Ryuta Kamizono</em></p>
</li></ul>

<h2 id="label-Rails+6.0.1+-28November+5-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.1 (November 5, 2019)</h2>
<ul><li>
<p>Common Table Expressions are allowed on read-only connections.</p>

<p> <em>Chris Morris</em></p>
</li><li>
<p>New record instantiation respects <code>unscope</code>.</p>

<p> <em>Ryuta Kamizono</em></p>
</li><li>
<p>Fixed a case where <code>find_in_batches</code> could halt too early.</p>

<p> <em>Takayuki Nakata</em></p>
</li><li>
<p>Autosaved associations always perform validations when a custom validation  context is used.</p>

<p> <em>Tekin Suleyman</em></p>
</li><li>
<p><code>sql.active_record</code> notifications now include the <code>:connection</code> in  their payloads.</p>

<p> <em>Eugene Kenny</em></p>
</li><li>
<p>A rollback encountered in an <code>after_commit</code> callback does not reset  previously-committed record state.</p>

<p> <em>Ryuta Kamizono</em></p>
</li><li>
<p>Fixed that join order was lost when eager-loading.</p>

<p> <em>Ryuta Kamizono</em></p>
</li><li>
<p><code>DESCRIBE</code> queries are allowed on read-only connections.</p>

<p><em>Dylan Thacker-Smith</em></p>
</li><li>
<p>Fixed that records that had been <code>inspect</code>ed could not be marshaled.</p>

<p><em>Eugene Kenny</em></p>
</li><li>
<p>The connection pool reaper thread is respawned in forked processes. This fixes that idle connections in forked processes wouldn&#39;t be reaped.</p>

<p><em>John Hawthorn</em></p>
</li><li>
<p>The memoized result of <code>ActiveRecord::Relation#take</code> is properly cleared when <code>ActiveRecord::Relation#reset</code> or <code>ActiveRecord::Relation#reload</code> is called.</p>

<p><em>Anmol Arora</em></p>
</li><li>
<p>Fixed the performance regression for <code>primary_keys</code> introduced MySQL 8.0.</p>

<p><em>Hiroyuki Ishii</em></p>
</li><li>
<p><code>insert</code>, <code>insert_all</code>, <code>upsert</code>, and <code>upsert_all</code> now clear the query cache.</p>

<p><em>Eugene Kenny</em></p>
</li><li>
<p>Call <code>while_preventing_writes</code> directly from <code>connected_to</code>.</p>

<p>In some cases application authors want to use the database switching middleware and make explicit calls with <code>connected_to</code>. It&#39;s possible for an app to turn off writes and not turn them back on by the time we call <code>connected_to(role: :writing)</code>.</p>

<p>This change allows apps to fix this by assuming if a role is writing we want to allow writes, except in the case it&#39;s explicitly turned off.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Improve detection of <a href="../../classes/ActiveRecord/StatementTimeout.html"><code>ActiveRecord::StatementTimeout</code></a> with mysql2 adapter in the edge case when the query is terminated during filesort.</p>

<p><em>Kir Shatrov</em></p>
</li></ul>

<h2 id="label-Rails+6.0.0+-28August+16-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0 (August 16, 2019)</h2>
<ul><li>
<p>Preserve user supplied joins order as much as possible.</p>

<p>Fixes #36761, #34328, #24281, #12953.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Make the DATABASE_URL env variable only affect the primary connection. Add new env variables for multiple databases.</p>

<p><em>John Crepezzi</em>, <em>Eileen Uchitelle</em></p>
</li><li>
<p>Add a warning for enum elements with &#39;not_&#39; prefix.</p>

<pre><code>class Foo
  enum status: [:sent, :not_sent]
end
</code></pre>

<p><em>Edu Depetris</em></p>
</li><li>
<p>Make currency symbols optional for money column type in PostgreSQL</p>

<p><em>Joel Schneider</em></p>
</li></ul>

<h2 id="label-Rails+6.0.0.rc2+-28July+22-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0.rc2 (July 22, 2019)</h2>
<ul><li>
<p>Add database_exists? method to connection adapters to check if a database exists.</p>

<p><em>Guilherme Mansur</em></p>
</li><li>
<p>PostgreSQL: Fix GROUP BY with ORDER BY virtual count attribute.</p>

<p>Fixes #36022.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Make <a href="../../classes/ActiveRecord.html"><code>ActiveRecord</code></a> <code>ConnectionPool.connections</code> method thread-safe.</p>

<p>Fixes #36465.</p>

<p><em>Jeff Doering</em></p>
</li><li>
<p>Fix sqlite3 collation parsing when using decimal columns.</p>

<p><em>Martin R. Schuster</em></p>
</li><li>
<p>Fix invalid schema when primary key column has a comment.</p>

<p>Fixes #29966.</p>

<p><em>Guilherme Goettems Schneider</em></p>
</li><li>
<p>Fix table comment also being applied to the primary key column.</p>

<p><em>Guilherme Goettems Schneider</em></p>
</li><li>
<p>Fix merging left_joins to maintain its own <code>join_type</code> context.</p>

<p>Fixes #36103.</p>

<p><em>Ryuta Kamizono</em></p>
</li></ul>

<h2 id="label-Rails+6.0.0.rc1+-28April+24-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0.rc1 (April 24, 2019)</h2>
<ul><li>
<p>Add <code>touch</code> option to <code>has_one</code> association.</p>

<p><em>Abhay Nikam</em></p>
</li><li>
<p>Deprecate <code>where.not</code> working as NOR and will be changed to NAND in <a href="../../classes/Rails.html"><code>Rails</code></a> 6.1.</p>

<pre><code>all = [treasures(:diamond), treasures(:sapphire), cars(:honda), treasures(:sapphire)]
assert_equal all, PriceEstimate.all.map(&amp;:estimate_of)
</code></pre>

<p>In <a href="../../classes/Rails.html"><code>Rails</code></a> 6.0:</p>

<pre><code>sapphire = treasures(:sapphire)

nor = all.reject { |e|
  e.estimate_of_type == sapphire.class.polymorphic_name
}.reject { |e|
  e.estimate_of_id == sapphire.id
}
assert_equal [cars(:honda)], nor

without_sapphire = PriceEstimate.where.not(
  estimate_of_type: sapphire.class.polymorphic_name, estimate_of_id: sapphire.id
)
assert_equal nor, without_sapphire.map(&amp;:estimate_of)
</code></pre>

<p>In <a href="../../classes/Rails.html"><code>Rails</code></a> 6.1:</p>

<pre><code>sapphire = treasures(:sapphire)

nand = all - [sapphire]
assert_equal [treasures(:diamond), cars(:honda)], nand

without_sapphire = PriceEstimate.where.not(
  estimate_of_type: sapphire.class.polymorphic_name, estimate_of_id: sapphire.id
)
assert_equal nand, without_sapphire.map(&amp;:estimate_of)
</code></pre>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fix dirty tracking after rollback.</p>

<p>Fixes #15018, #30167, #33868.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Add <code>ActiveRecord::Relation#cache_version</code> to support recyclable cache keys via the versioned entries in <code>ActiveSupport::Cache</code>. This also means that <code>ActiveRecord::Relation#cache_key</code> will now return a stable key that does not include the max timestamp or count any more.</p>

<p>NOTE: This feature is turned off by default, and <code>cache_key</code> will still return cache keys with timestamps until you set <code>ActiveRecord::Base.collection_cache_versioning = true</code>. That&#39;s the setting for all new apps on <a href="../../classes/Rails.html"><code>Rails</code></a> 6.0+</p>

<p><em>Lachlan Sylvester</em></p>
</li><li>
<p>Fix dirty tracking for <code>touch</code> to track saved changes.</p>

<p>Fixes #33429.</p>

<p><em>Ryuta Kamzono</em></p>
</li><li>
<p><code>change_column_comment</code> and <code>change_table_comment</code> are invertible only if <code>to</code> and <code>from</code> options are specified.</p>

<p><em>Yoshiyuki Kinjo</em></p>
</li><li>
<p>Don&#39;t call commit/rollback callbacks when a record isn&#39;t saved.</p>

<p>Fixes #29747.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fix circular <code>autosave: true</code> causes invalid records to be saved.</p>

<p>Prior to the fix, when there was a circular series of <code>autosave: true</code> associations, the callback for a <code>has_many</code> association was run while another instance of the same callback on the same association hadn&#39;t finished running. When control returned to the first instance of the callback, the instance variable had changed, and subsequent associated records weren&#39;t saved correctly. Specifically, the ID field for the <code>belongs_to</code> corresponding to the <code>has_many</code> was <code>nil</code>.</p>

<p>Fixes #28080.</p>

<p><em>Larry Reid</em></p>
</li><li>
<p>Raise <code>ArgumentError</code> for invalid <code>:limit</code> and <code>:precision</code> like as other options.</p>

<p>Before:</p>

<pre><code>add_column :items, :attr1, :binary,   size: 10      # =&gt; ArgumentError
add_column :items, :attr2, :decimal,  scale: 10     # =&gt; ArgumentError
add_column :items, :attr3, :integer,  limit: 10     # =&gt; ActiveRecordError
add_column :items, :attr4, :datetime, precision: 10 # =&gt; ActiveRecordError
</code></pre>

<p>After:</p>

<pre><code>add_column :items, :attr1, :binary,   size: 10      # =&gt; ArgumentError
add_column :items, :attr2, :decimal,  scale: 10     # =&gt; ArgumentError
add_column :items, :attr3, :integer,  limit: 10     # =&gt; ArgumentError
add_column :items, :attr4, :datetime, precision: 10 # =&gt; ArgumentError
</code></pre>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Association loading isn&#39;t to be affected by scoping consistently whether preloaded / eager loaded or not, with the exception of <code>unscoped</code>.</p>

<p>Before:</p>

<pre><code>Post.where(&quot;1=0&quot;).scoping do
  Comment.find(1).post                   # =&gt; nil
  Comment.preload(:post).find(1).post    # =&gt; #&lt;Post id: 1, ...&gt;
  Comment.eager_load(:post).find(1).post # =&gt; #&lt;Post id: 1, ...&gt;
end
</code></pre>

<p>After:</p>

<pre><code>Post.where(&quot;1=0&quot;).scoping do
  Comment.find(1).post                   # =&gt; #&lt;Post id: 1, ...&gt;
  Comment.preload(:post).find(1).post    # =&gt; #&lt;Post id: 1, ...&gt;
  Comment.eager_load(:post).find(1).post # =&gt; #&lt;Post id: 1, ...&gt;
end
</code></pre>

<p>Fixes #34638, #35398.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Add <code>rails db:prepare</code> to migrate or setup a database.</p>

<p>Runs <code>db:migrate</code> if the database exists or <code>db:setup</code> if it doesn&#39;t.</p>

<p><em>Roberto Miranda</em></p>
</li><li>
<p>Add <code>after_save_commit</code> callback as shortcut for <code>after_commit :hook, on: [ :create, :update ]</code>.</p>

<p><em>DHH</em></p>
</li><li>
<p>Assign all attributes before calling <code>build</code> to ensure the child record is visible in <code>before_add</code> and <code>after_add</code> callbacks for <code>has_many :through</code> associations.</p>

<p>Fixes #33249.</p>

<p><em>Ryan H. Kerr</em></p>
</li><li>
<p>Add <code>ActiveRecord::Relation#extract_associated</code> for extracting associated records from a relation.</p>

<pre><code>account.memberships.extract_associated(:user)
# =&gt; Returns collection of User records
</code></pre>

<p><em>DHH</em></p>
</li><li>
<p>Add <code>ActiveRecord::Relation#annotate</code> for adding SQL comments to its queries.</p>

<p>For example:</p>

<pre><code>Post.where(id: 123).annotate(&quot;this is a comment&quot;).to_sql
# SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = 123 /* this is a comment */
</code></pre>

<p>This can be useful in instrumentation or other analysis of issued queries.</p>

<p><em>Matt Yoho</em></p>
</li><li>
<p>Support Optimizer Hints.</p>

<p>In most databases, a way to control the optimizer is by using optimizer hints, which can be specified within individual statements.</p>

<p>Example (for MySQL):</p>

<pre><code>Topic.optimizer_hints(&quot;MAX_EXECUTION_TIME(50000)&quot;, &quot;NO_INDEX_MERGE(topics)&quot;)
# SELECT /*+ MAX_EXECUTION_TIME(50000) NO_INDEX_MERGE(topics) */ `topics`.* FROM `topics`
</code></pre>

<p>Example (for PostgreSQL with pg_hint_plan):</p>

<pre><code>Topic.optimizer_hints(&quot;SeqScan(topics)&quot;, &quot;Parallel(topics 8)&quot;)
# SELECT /*+ SeqScan(topics) Parallel(topics 8) */ &quot;topics&quot;.* FROM &quot;topics&quot;
</code></pre>

<p>See also:</p>
<ul><li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/optimizer-hints.html">dev.mysql.com/doc/refman/8.0/en/optimizer-hints.html</a></p>
</li><li>
<p><a href="https://pghintplan.osdn.jp/pg_hint_plan.html">pghintplan.osdn.jp/pg_hint_plan.html</a></p>
</li><li>
<p><a href="https://docs.oracle.com/en/database/oracle/oracle-database/12.2/tgsql/influencing-the-optimizer.html">docs.oracle.com/en/database/oracle/oracle-database/12.2/tgsql/influencing-the-optimizer.html</a></p>
</li><li>
<p><a href="https://docs.microsoft.com/en-us/sql/t-sql/queries/hints-transact-sql-query?view=sql-server-2017">docs.microsoft.com/en-us/sql/t-sql/queries/hints-transact-sql-query?view=sql-server-2017</a></p>
</li><li>
<p><a href="https://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.admin.perf.doc/doc/c0070117.html">www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.admin.perf.doc/doc/c0070117.html</a></p>
</li></ul>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fix query attribute method on user-defined attribute to be aware of typecasted value.</p>

<p>For example, the following code no longer return false as casted non-empty string:</p>

<pre><code>class Post &lt; ActiveRecord::Base
  attribute :user_defined_text, :text
end

Post.new(user_defined_text: &quot;false&quot;).user_defined_text? # =&gt; true
</code></pre>

<p><em>Yuji Kamijima</em></p>
</li><li>
<p>Quote empty ranges like other empty enumerables.</p>

<p><em>Patrick Rebsch</em></p>
</li><li>
<p>Add <code>insert_all</code>/<code>insert_all!</code>/<code>upsert_all</code> methods to <code>ActiveRecord::Persistence</code>, allowing bulk inserts akin to the bulk updates provided by <code>update_all</code> and bulk deletes by <code>delete_all</code>.</p>

<p>Supports skipping or upserting duplicates through the <code>ON CONFLICT</code> syntax for PostgreSQL (9.5+) and SQLite (3.24+) and <code>ON DUPLICATE KEY UPDATE</code> syntax for MySQL.</p>

<p><em>Bob Lail</em></p>
</li><li>
<p>Add <code>rails db:seed:replant</code> that truncates tables of each database for current environment and loads the seeds.</p>

<p><em>bogdanvlviv</em>, <em>DHH</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base.connection.truncate</code> for SQLite3 adapter.</p>

<p><em>bogdanvlviv</em></p>
</li><li>
<p>Deprecate mismatched collation comparison for uniqueness validator.</p>

<p>Uniqueness validator will no longer enforce case sensitive comparison in <a href="../../classes/Rails.html"><code>Rails</code></a> 6.1. To continue case sensitive comparison on the case insensitive column, pass <code>case_sensitive: true</code> option explicitly to the uniqueness validator.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Add <code>reselect</code> method. This is a short-hand for <code>unscope(:select).select(fields)</code>.</p>

<p>Fixes #27340.</p>

<p><em>Willian Gustavo Veiga</em></p>
</li><li>
<p>Add negative scopes for all enum values.</p>

<p>Example:</p>

<pre><code>class Post &lt; ActiveRecord::Base
  enum status: %i[ drafted active trashed ]
end

Post.not_drafted # =&gt; where.not(status: :drafted)
Post.not_active  # =&gt; where.not(status: :active)
Post.not_trashed # =&gt; where.not(status: :trashed)
</code></pre>

<p><em>DHH</em></p>
</li><li>
<p>Fix different <code>count</code> calculation when using <code>size</code> with manual <code>select</code> with DISTINCT.</p>

<p>Fixes #35214.</p>

<p><em>Juani Villarejo</em></p>
</li></ul>

<h2 id="label-Rails+6.0.0.beta3+-28March+11-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0.beta3 (March 11, 2019)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+6.0.0.beta2+-28February+25-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0.beta2 (February 25, 2019)</h2>
<ul><li>
<p>Fix prepared statements caching to be enabled even when query caching is enabled.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Ensure <code>update_all</code> series cares about optimistic locking.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Don&#39;t allow <code>where</code> with non numeric string matches to 0 values.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Introduce <code>ActiveRecord::Relation#destroy_by</code> and <code>ActiveRecord::Relation#delete_by</code>.</p>

<p><code>destroy_by</code> allows relation to find all the records matching the condition and perform <code>destroy_all</code> on the matched records.</p>

<p>Example:</p>

<pre><code>Person.destroy_by(name: &#39;David&#39;)
Person.destroy_by(name: &#39;David&#39;, rating: 4)

david = Person.find_by(name: &#39;David&#39;)
david.posts.destroy_by(id: [1, 2, 3])
</code></pre>

<p><code>delete_by</code> allows relation to find all the records matching the condition and perform <code>delete_all</code> on the matched records.</p>

<p>Example:</p>

<pre><code>Person.delete_by(name: &#39;David&#39;)
Person.delete_by(name: &#39;David&#39;, rating: 4)

david = Person.find_by(name: &#39;David&#39;)
david.posts.delete_by(id: [1, 2, 3])
</code></pre>

<p><em>Abhay Nikam</em></p>
</li><li>
<p>Don&#39;t allow <code>where</code> with invalid value matches to nil values.</p>

<p>Fixes #33624.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>SQLite3: Implement <code>add_foreign_key</code> and <code>remove_foreign_key</code>.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Deprecate using class level querying methods if the receiver scope regarded as leaked. Use <code>klass.unscoped</code> to avoid the leaking scope.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Allow applications to automatically switch connections.</p>

<p>Adds a middleware and configuration options that can be used in your application to automatically switch between the writing and reading database connections.</p>

<p><code>GET</code> and <code>HEAD</code> requests will read from the replica unless there was a write in the last 2 seconds, otherwise they will read from the primary. Non-get requests will always write to the primary. The middleware accepts an argument for a Resolver class and an Operations class where you are able to change how the auto-switcher works to be most beneficial for your application.</p>

<p>To use the middleware in your application you can use the following configuration options:</p>

<pre><code>config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
</code></pre>

<p>To change the database selection strategy, pass a custom class to the configuration options:</p>

<pre><code>config.active_record.database_selector = { delay: 10.seconds }
config.active_record.database_resolver = MyResolver
config.active_record.database_resolver_context = MyResolver::MyCookies
</code></pre>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>MySQL: Support <code>:size</code> option to change text and blob size.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Make <code>t.timestamps</code> with precision by default.</p>

<p><em>Ryuta Kamizono</em></p>
</li></ul>

<h2 id="label-Rails+6.0.0.beta1+-28January+18-2C+2019-29"><a href="../../classes/Rails.html"><code>Rails</code></a> 6.0.0.beta1 (January 18, 2019)</h2>
<ul><li>
<p>Remove deprecated <code>#set_state</code> from the transaction object.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>#supports_statement_cache?</code> from the database adapters.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>#insert_fixtures</code> from the database adapters.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::ConnectionAdapters::SQLite3Adapter#valid_alter_table_type?</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Do not allow passing the column name to <code>sum</code> when a block is passed.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Do not allow passing the column name to <code>count</code> when a block is passed.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove delegation of missing methods in a relation to arel.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove delegation of missing methods in a relation to private methods of the class.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecate <code>config.active_record.sqlite3.represent_boolean_as_integer</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Change <code>SQLite3Adapter</code> to always represent boolean values as integers.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove ability to specify a timestamp name for <code>#cache_key</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Migrator.migrations_path=</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>expand_hash_conditions_for_aggregates</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Set polymorphic type column to NULL on <code>dependent: :nullify</code> strategy.</p>

<p>On polymorphic associations both the foreign key and the foreign type columns will be set to NULL.</p>

<p><em>Laerti Papa</em></p>
</li><li>
<p>Allow permitted instance of <code>ActionController::Parameters</code> as argument of <code>ActiveRecord::Relation#exists?</code>.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Add support for endless ranges introduces in Ruby 2.6.</p>

<p><em>Greg Navis</em></p>
</li><li>
<p>Deprecate passing <code>migrations_paths</code> to <code>connection.assume_migrated_upto_version</code>.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>MySQL: <code>ROW_FORMAT=DYNAMIC</code> create table option by default.</p>

<p>Since MySQL 5.7.9, the <code>innodb_default_row_format</code> option defines the default row format for InnoDB tables. The default setting is <code>DYNAMIC</code>. The row format is required for indexing on <code>varchar(255)</code> with <code>utf8mb4</code> columns.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fix join table column quoting with SQLite.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Allow disabling scopes generated by <code>ActiveRecord.enum</code>.</p>

<p><em>Alfred Dominic</em></p>
</li><li>
<p>Ensure that <code>delete_all</code> on collection proxy returns affected count.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Reset scope after delete on collection association to clear stale offsets of removed records.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Add the ability to prevent writes to a database for the duration of a block.</p>

<p>Allows the application to prevent writes to a database. This can be useful when you&#39;re building out multiple databases and want to make sure you&#39;re not sending writes when you want a read.</p>

<p>If <code>while_preventing_writes</code> is called and the query is considered a write query the database will raise an exception regardless of whether the database user is able to write.</p>

<p>This is not meant to be a catch-all for write queries but rather a way to enforce read-only queries without opening a second connection. One purpose of this is to catch accidental writes, not all writes.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Allow aliased attributes to be used in <code>#update_columns</code> and <code>#update</code>.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Allow spaces in postgres table names.</p>

<p>Fixes issue where "user post" is misinterpreted as "&quot;user&quot;.&quot;post&quot;" when quoting table names with the postgres adapter.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Cached <code>columns_hash</code> fields should be excluded from <code>ResultSet#column_types</code>.</p>

<p>PR #34528 addresses the inconsistent behaviour when attribute is defined for an ignored column. The following test was passing for SQLite and MySQL, but failed for PostgreSQL:</p>

<pre><code>class DeveloperName &lt; ActiveRecord::Type::String
  def deserialize(value)
    &quot;Developer: #{value}&quot;
  end
end

class AttributedDeveloper &lt; ActiveRecord::Base
  self.table_name = &quot;developers&quot;

  attribute :name, DeveloperName.new

  self.ignored_columns += [&quot;name&quot;]
end

developer = AttributedDeveloper.create
developer.update_column :name, &quot;name&quot;

loaded_developer = AttributedDeveloper.where(id: developer.id).select(&quot;*&quot;).first
puts loaded_developer.name # should be &quot;Developer: name&quot; but it&#39;s just &quot;name&quot;
</code></pre>

<p><em>Dmitry Tsepelev</em></p>
</li><li>
<p>Make the implicit order column configurable.</p>

<p>When calling ordered finder methods such as <code>first</code> or <code>last</code> without an explicit order clause, <a href="../../classes/ActiveRecord.html"><code>ActiveRecord</code></a> sorts records by primary key. This can result in unpredictable and surprising behaviour when the primary key is not an auto-incrementing integer, for example when it&#39;s a UUID. This change makes it possible to override the column used for implicit ordering such that <code>first</code> and <code>last</code> will return more predictable results.</p>

<p>Example:</p>

<pre><code>class Project &lt; ActiveRecord::Base
  self.implicit_order_column = &quot;created_at&quot;
end
</code></pre>

<p><em>Tekin Suleyman</em></p>
</li><li>
<p>Bump minimum PostgreSQL version to 9.3.</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>Values of enum are frozen, raising an error when attempting to modify them.</p>

<p><em>Emmanuel Byrd</em></p>
</li><li>
<p>Move <code>ActiveRecord::StatementInvalid</code> SQL to error property and include binds as separate error property.</p>

<p><code>ActiveRecord::ConnectionAdapters::AbstractAdapter#translate_exception_class</code> now requires <code>binds</code> to be passed as the last argument.</p>

<p><code>ActiveRecord::ConnectionAdapters::AbstractAdapter#translate_exception</code> now requires <code>message</code>, <code>sql</code>, and <code>binds</code> to be passed as keyword arguments.</p>

<p>Subclasses of <code>ActiveRecord::StatementInvalid</code> must now provide <code>sql:</code> and <code>binds:</code> arguments to <code>super</code>.</p>

<p>Example:</p>

<pre><code>class MySubclassedError &lt; ActiveRecord::StatementInvalid
  def initialize(message, sql:, binds:)
    super(message, sql: sql, binds: binds)
  end
end
</code></pre>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Add an <code>:if_not_exists</code> option to <code>create_table</code>.</p>

<p>Example:</p>

<pre><code>create_table :posts, if_not_exists: true do |t|
  t.string :title
end
</code></pre>

<p>That would execute:</p>

<pre><code>CREATE TABLE IF NOT EXISTS posts (
  ...
)
</code></pre>

<p>If the table already exists, <code>if_not_exists: false</code> (the default) raises an exception whereas <code>if_not_exists: true</code> does nothing.</p>

<p><em>fatkodima</em>, <em>Stefan Kanev</em></p>
</li><li>
<p>Defining an Enum as a <a href="../../classes/Hash.html"><code>Hash</code></a> with blank key, or as an <a href="../../classes/Array.html"><code>Array</code></a> with a blank value, now raises an <code>ArgumentError</code>.</p>

<p><em>Christophe Maximin</em></p>
</li><li>
<p>Adds support for multiple databases to <code>rails db:schema:cache:dump</code> and <code>rails db:schema:cache:clear</code>.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p><code>update_columns</code> now correctly raises <code>ActiveModel::MissingAttributeError</code> if the attribute does not exist.</p>

<p><em>Sean Griffin</em></p>
</li><li>
<p>Add support for hash and URL configs in database hash of <code>ActiveRecord::Base.connected_to</code>.</p>

<p>"" User.connected_to(database: { writing: "postgres://foo" }) do  User.create!(name: "Gannon") end</p>

<p>config = { "adapter" =&gt; "sqlite3", "database" =&gt; "db/readonly.sqlite3" } User.connected_to(database: { reading: config }) do  User.count end ""</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Support default expression for MySQL.</p>

<p>MySQL 8.0.13 and higher supports default value to be a function or expression.</p>

<p><a href="https://dev.mysql.com/doc/refman/8.0/en/create-table.html">dev.mysql.com/doc/refman/8.0/en/create-table.html</a></p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Support expression indexes for MySQL.</p>

<p>MySQL 8.0.13 and higher supports functional key parts that index expression values rather than column or column prefix values.</p>

<p><a href="https://dev.mysql.com/doc/refman/8.0/en/create-index.html">dev.mysql.com/doc/refman/8.0/en/create-index.html</a></p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fix collection cache key with limit and custom select to avoid ambiguous timestamp column error.</p>

<p>Fixes #33056.</p>

<p><em>Federico Martinez</em></p>
</li><li>
<p>Add basic API for connection switching to support multiple databases.</p>

<p>1) Adds a <code>connects_to</code> method for models to connect to multiple databases. Example:</p>

<pre><code>class AnimalsModel &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals_primary, reading: :animals_replica }
end

class Dog &lt; AnimalsModel
  # connected to both the animals_primary db for writing and the animals_replica for reading
end
</code></pre>

<p>2) Adds a <code>connected_to</code> block method for switching connection roles or connecting to a database that the model didn&#39;t connect to. Connecting to the database in this block is useful when you have another defined connection, for example <code>slow_replica</code> that you don&#39;t want to connect to by default but need in the console, or a specific code block.</p>

<pre><code>ActiveRecord::Base.connected_to(role: :reading) do
  Dog.first # finds dog from replica connected to AnimalsBase
  Book.first # doesn&#39;t have a reading connection, will raise an error
end
</code></pre>

<pre><code>ActiveRecord::Base.connected_to(database: :slow_replica) do
  SlowReplicaModel.first # if the db config has a slow_replica configuration this will be used to do the lookup, otherwise this will throw an exception
end
</code></pre>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Enum raises on invalid definition values</p>

<p>When defining a <a href="../../classes/Hash.html"><code>Hash</code></a> enum it can be easy to use <code>[]</code> instead of <code>{}</code>. This commit checks that only valid definition values are provided, those can be a <a href="../../classes/Hash.html"><code>Hash</code></a>, an array of Symbols or an array of Strings. Otherwise it raises an <code>ArgumentError</code>.</p>

<p>Fixes #33961</p>

<p><em>Alberto Almagro</em></p>
</li><li>
<p>Reloading associations now clears the Query Cache like <code>Persistence#reload</code> does.</p>

<pre><code>class Post &lt; ActiveRecord::Base
  has_one :category
  belongs_to :author
  has_many :comments
end

# Each of the following will now clear the query cache.
post.reload_category
post.reload_author
post.comments.reload
</code></pre>

<p><em>Christophe Maximin</em></p>
</li><li>
<p>Added <code>index</code> option for <code>change_table</code> migration helpers. With this change you can create indexes while adding new columns into the existing tables.</p>

<p>Example:</p>

<pre><code>change_table(:languages) do |t|
  t.string :country_code, index: true
end
</code></pre>

<p><em>Mehmet Emin İNAÇ</em></p>
</li><li>
<p>Fix <code>transaction</code> reverting for migrations.</p>

<p>Before: Commands inside a <code>transaction</code> in a reverted migration ran uninverted. Now: This change fixes that by reverting commands inside <code>transaction</code> block.</p>

<p><em>fatkodima</em>, <em>David Verhasselt</em></p>
</li><li>
<p>Raise an error instead of scanning the filesystem root when <code>fixture_path</code> is blank.</p>

<p><em>Gannon McGibbon</em>, <em>Max Albrecht</em></p>
</li><li>
<p>Allow <code>ActiveRecord::Base.configurations=</code> to be set with a symbolized hash.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Don&#39;t update counter cache unless the record is actually saved.</p>

<p>Fixes #31493, #33113, #33117.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Deprecate <code>ActiveRecord::Result#to_hash</code> in favor of <code>ActiveRecord::Result#to_a</code>.</p>

<p><em>Gannon McGibbon</em>, <em>Kevin Cheng</em></p>
</li><li>
<p>SQLite3 adapter supports expression indexes.</p>

<pre><code>create_table :users do |t|
  t.string :email
end

add_index :users, &#39;lower(email)&#39;, name: &#39;index_users_on_email&#39;, unique: true
</code></pre>

<p><em>Gray Kemmey</em></p>
</li><li>
<p>Allow subclasses to redefine autosave callbacks for associated records.</p>

<p>Fixes #33305.</p>

<p><em>Andrey Subbota</em></p>
</li><li>
<p>Bump minimum MySQL version to 5.5.8.</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>Use MySQL utf8mb4 character set by default.</p>

<p><code>utf8mb4</code> character set with 4-Byte encoding supports supplementary characters including emoji. The previous default 3-Byte encoding character set <code>utf8</code> is not enough to support them.</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>Fix duplicated record creation when using nested attributes with <code>create_with</code>.</p>

<p><em>Darwin Wu</em></p>
</li><li>
<p>Configuration item <code>config.filter_parameters</code> could also filter out sensitive values of database columns when calling <code>#inspect</code>. We also added <code>ActiveRecord::Base::filter_attributes</code>/<code>=</code> in order to specify sensitive attributes to specific model.</p>

<pre><code>Rails.application.config.filter_parameters += [:credit_card_number, /phone/]
Account.last.inspect # =&gt; #&lt;Account id: 123, name: &quot;DHH&quot;, credit_card_number: [FILTERED], telephone_number: [FILTERED] ...&gt;
SecureAccount.filter_attributes += [:name]
SecureAccount.last.inspect # =&gt; #&lt;SecureAccount id: 42, name: [FILTERED], credit_card_number: [FILTERED] ...&gt;
</code></pre>

<p><em>Zhang Kang</em>, <em>Yoshiyuki Kinjo</em></p>
</li><li>
<p>Deprecate <code>column_name_length</code>, <code>table_name_length</code>, <code>columns_per_table</code>, <code>indexes_per_table</code>, <code>columns_per_multicolumn_index</code>, <code>sql_query_length</code>, and <code>joins_per_query</code> methods in <code>DatabaseLimits</code>.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p><code>ActiveRecord::Base.configurations</code> now returns an object.</p>

<p><code>ActiveRecord::Base.configurations</code> used to return a hash, but this is an inflexible data model. In order to improve multiple-database handling in <a href="../../classes/Rails.html"><code>Rails</code></a>, we&#39;ve changed this to return an object. Some methods are provided to make the object behave hash-like in order to ease the transition process. Since most applications don&#39;t manipulate the hash we&#39;ve decided to add backwards-compatible functionality that will throw a deprecation warning if used, however calling <code>ActiveRecord::Base.configurations</code> will use the new version internally and externally.</p>

<p>For example, the following <code>database.yml</code>:</p>

<pre><code>development:
  adapter: sqlite3
  database: db/development.sqlite3
</code></pre>

<p>Used to become a hash:</p>

<pre><code>{ &quot;development&quot; =&gt; { &quot;adapter&quot; =&gt; &quot;sqlite3&quot;, &quot;database&quot; =&gt; &quot;db/development.sqlite3&quot; } }
</code></pre>

<p>Is now converted into the following object:</p>

<pre><code>#&lt;ActiveRecord::DatabaseConfigurations:0x00007fd1acbdf800 @configurations=[
  #&lt;ActiveRecord::DatabaseConfigurations::HashConfig:0x00007fd1acbded10 @env_name=&quot;development&quot;,
    @spec_name=&quot;primary&quot;, @config={&quot;adapter&quot;=&gt;&quot;sqlite3&quot;, &quot;database&quot;=&gt;&quot;db/development.sqlite3&quot;}&gt;
  ]
</code></pre>

<p>Iterating over the database configurations has also changed. Instead of calling hash methods on the <code>configurations</code> hash directly, a new method <code>configs_for</code> has been provided that allows you to select the correct configuration. <code>env_name</code> and <code>spec_name</code> arguments are optional. For example, these return an array of database config objects for the requested environment and a single database config object will be returned for the requested environment and specification name respectively.</p>

<pre><code>ActiveRecord::Base.configurations.configs_for(env_name: &quot;development&quot;)
ActiveRecord::Base.configurations.configs_for(env_name: &quot;development&quot;, spec_name: &quot;primary&quot;)
</code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>Aaron Patterson</em></p>
</li><li>
<p>Add database configuration to disable advisory locks.</p>

<pre><code>production:
  adapter: postgresql
  advisory_locks: false
</code></pre>

<p><em>Guo Xiang</em></p>
</li><li>
<p>SQLite3 adapter <code>alter_table</code> method restores foreign keys.</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>Allow <code>:to_table</code> option to <code>invert_remove_foreign_key</code>.</p>

<p>Example:</p>

<p>remove_foreign_key :accounts, to_table: :owners</p>

<p><em>Nikolay Epifanov</em>, <em>Rich Chen</em></p>
</li><li>
<p>Add environment &amp; load_config dependency to <code>bin/rake db:seed</code> to enable seed load in environments without <a href="../../classes/Rails.html"><code>Rails</code></a> and custom DB configuration</p>

<p><em>Tobias Bielohlawek</em></p>
</li><li>
<p>Fix default value for mysql time types with specified precision.</p>

<p><em>Nikolay Kondratyev</em></p>
</li><li>
<p>Fix <code>touch</code> option to behave consistently with <code>Persistence#touch</code> method.</p>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Migrations raise when duplicate column definition.</p>

<p>Fixes #33024.</p>

<p><em>Federico Martinez</em></p>
</li><li>
<p>Bump minimum SQLite version to 3.8</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>Fix parent record should not get saved with duplicate children records.</p>

<p>Fixes #32940.</p>

<p><em>Santosh Wadghule</em></p>
</li><li>
<p>Fix logic on disabling commit callbacks so they are not called unexpectedly when errors occur.</p>

<p><em>Brian Durand</em></p>
</li><li>
<p>Ensure <code>Associations::CollectionAssociation#size</code> and <code>Associations::CollectionAssociation#empty?</code> use loaded association ids if present.</p>

<p><em>Graham Turner</em></p>
</li><li>
<p>Add support to preload associations of polymorphic associations when not all the records have the requested associations.</p>

<p><em>Dana Sherson</em></p>
</li><li>
<p>Add <code>touch_all</code> method to <code>ActiveRecord::Relation</code>.</p>

<p>Example:</p>

<pre><code>Person.where(name: &quot;David&quot;).touch_all(time: Time.new(2020, 5, 16, 0, 0, 0))
</code></pre>

<p><em>fatkodima</em>, <em>duggiefresh</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base.base_class?</code> predicate.</p>

<p><em>Bogdan Gusiev</em></p>
</li><li>
<p>Add custom prefix/suffix options to <code>ActiveRecord::Store.store_accessor</code>.</p>

<p><em>Tan Huynh</em>, <em>Yukio Mizuta</em></p>
</li><li>
<p><a href="../../classes/Rails.html"><code>Rails</code></a> 6 requires Ruby 2.5.0 or newer.</p>

<p><em>Jeremy Daer</em>, <em>Kasper Timm Hansen</em></p>
</li><li>
<p>Deprecate <code>update_attributes</code>/<code>!</code> in favor of <code>update</code>/<code>!</code>.</p>

<p><em>Eddie Lebow</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base.create_or_find_by</code>/<code>!</code> to deal with the SELECT/INSERT race condition in <code>ActiveRecord::Base.find_or_create_by</code>/<code>!</code> by leaning on unique constraints in the database.</p>

<p><em>DHH</em></p>
</li><li>
<p>Add <code>Relation#pick</code> as short-hand for single-value plucks.</p>

<p><em>DHH</em></p>
</li></ul>

<p>Please check <a href="https://github.com/rails/rails/blob/5-2-stable/activerecord/CHANGELOG.md">5-2-stable</a> for previous changes.</p>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
    
    
    
  
</div>

    </div>
  </body>
</html>
